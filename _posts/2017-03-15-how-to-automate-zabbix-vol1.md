---
layout: post
title:  "–ö–∞–∫ —è Zabbix –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–ª. –ß–∞—Å—Ç—å 1."
date:   2017-04-15
desc: "–ö–∞–∫ —è –Ω–∞—á–∞–ª –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–∫–∞—Ç–∫—É zabbix –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ö–æ—Å—Ç–æ–≤ –ø–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –≥—Ä—É–ø–ø–∞–º"
keywords: "Zabbix,–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è Zabbix,Zabbix –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥,Zabbix,–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥,Ansible Zabbix"
categories: [Zabbix]
tags: [Zabbix,Ansible,–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥]
icon: fa fa-television
---

## –ü—Ä–µ–¥–∏—Å–ª–æ–≤–∏–µ ######

–†–∞–Ω–æ –∏–ª–∏ –ø–æ–∑–¥–Ω–æ, –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–±–æ—Ç—ã —Å Zabbix –≤—Å—Ç–∞–µ—Ç –≤–æ–ø—Ä–æ—Å –æ–± –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏. –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ —Ä–∞–∑–Ω—ã–º –ø—Ä–∏—á–∏–Ω–∞–º: —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ö–æ—Å—Ç–æ–≤, –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–∞ –∏ —Ç—É–ø–æ –ª–µ–Ω—å. –í—Å–µ —Å–≤–æ–¥–∏—Ç—Å—è –∫ –≤–æ–ø—Ä–æ—Å—É: "–ê –∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã —è –Ω–∞–∂–∞–ª –Ω–∞ –∫–Ω–æ–ø–∫—É –∏ –ø–æ—à–µ–ª –ø–∏—Ç—å –∫–æ—Ñ–µ, –∞ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É —É–∂–µ –≤—Å–µ –º–æ–Ω–∏—Ç—Ä–∏—Ç—Å—è –∏ —è –º–æ–ª–æ–¥–µ—Ü!". –°—Ä–∞–∑—É –ø–æ—è—Å–Ω—é, —á—Ç–æ —Ç–æ—Ç —Å–ø–æ—Å–æ–± –∫–æ—Ç–æ—Ä—ã–π –±—É–¥—É –æ–ø–∏—Å—ã–≤–∞—Ç—å —è, –∫–∞—Å—Ç–æ–º–Ω—ã–π, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥—Ö–æ–¥–∏–ª –º–Ω–µ. –Ø —É–≤–µ—Ä–µ–Ω –µ—Å—Ç—å –º–Ω–æ–≥–æ —Ä–∞–∑–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –¥–∞–∂–µ —á—Ç–æ-—Ç–æ –µ—Å—Ç—å –∏–∑ –∫–æ—Ä–æ–±–∫–∏, –Ω–æ —è —Ä–µ—à–∏–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É—Ç—å –¥–∂–µ–¥–∞—è –∏ –Ω–∞–ø–∏—Å–∞—Ç—å –≤—Å–µ —Å –Ω–∞—á–∞–ª–∞ =) –ò—Ç–∞–∫, –±–ª–∏–∂–µ –∫ –¥–µ–ª—É.

<br/>

## –ù–∞—á–∞–ª–æ ######

–¶–µ–ª—å –±—ã–ª–∞ —Ç–∞–∫–∞—è. –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Ö–æ—Å—Ç–æ–≤, –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–∞—è DNS –∑–∞–ø–∏—Å—å –æ —Å–µ—Ä–≤–µ—Ä–µ. –≠—Ç–∞ –∑–∞–ø–∏—Å—å –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ—Ç—Å—è –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∏–Ω–≤–µ–Ω—Ç–æ—Ä–∏ —Ñ–∞–π–ª ansible. –ó–∞–ø–∏–ª–∏—Ç—å playbook, –∫–æ—Ç–æ—Ä—ã–π –±—ã —Å—Ç–∞–≤–∏–ª –∞–≥–µ–Ω—Ç–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ö–æ—Å—Ç, –∞ —Ç–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–ª –±—ã —ç—Ç–æ—Ç —Ö–æ—Å—Ç –≤ –≤–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Zabbix, –¥–æ–±–∞–≤–ª—è–ª –Ω—É–∂–Ω—ã–π —à–∞–±–ª–æ–Ω, –¥–æ–±–∞–≤–ª—è–ª —ç—Ç–æ—Ç —Å–µ—Ä–≤–µ—Ä –≤ –Ω—É–∂–Ω—ã–µ –≥—Ä—É–ø–ø—ã, –Ω—É –∏ –¥–∞–≤–∞–ª –ø—Ä–∞–≤–∞ –Ω–∞ —ç—Ç–∏ –≥—Ä—É–ø–ø—ã —Ö–æ—Å—Ç–æ–≤, –≥—Ä—É–ø–ø–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π(–¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π).

<br/>

## –ü–æ—á–µ–º—É Ansible? ######

–¢—É—Ç –≤—Å–µ –ø—Ä–æ—Å—Ç–æ. –ï—Å—Ç—å –º–Ω–æ–≥–æ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤, –Ω–æ Ansible –¥–æ–≤–æ–ª—å–Ω–æ —Ç–∞–∫–∏ –Ω–µ–ø—Ä–∏—Ö–æ—Ç–ª–∏–≤. –ï–º—É –Ω–µ –Ω—É–∂–Ω—ã –∞–≥–µ–Ω—Ç—ã, –¥–æ —Ö–æ—Å—Ç–æ–≤ –æ–Ω —Å—Ç—É—á–∏—Ç—å—Å—è –ø–æ ssh, –∞ –Ω–∞ —Ö–æ—Å—Ç–∞—Ö –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–µ–¥—É—Å—Ç–∞–≤–Ω–æ–≤–ª–µ–Ω python 2.7 –∏ –≤—ã—à–µ –≤–µ—Ä—Å–∏–∏. –≠—Ç–æ –≤—Å–µ –µ—Å—Ç—å, —Ç–∞–∫ —è —Ä–∞–±–æ—Ç–∞—é –≤ 99% c Linux —Å–µ—Ä–≤–µ—Ä–∞–º–∏, –∞ —Ç–∞–º –ø–æ –¥–µ—Ñ–æ–ª—Ç—É —ç—Ç–æ –≤—Å–µ –µ—Å—Ç—å.

<br/>

## –¢–∞–∫ –∫–∞–∫–æ–π —Ö–æ—Å—Ç –Ω—É–∂–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å? ######

–ó–¥–µ—Å—å —è —Ö–æ—Ç–µ–ª –æ–ø–∏—Å–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ–¥–∏—Å–∫–∞–≤–µ—Ä–∏–Ω–≥–∞ DNS, –¥–∏—Ñ –∏ –ø–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π, –Ω–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –≤—Å–µ –∫–æ—Å—Ç—ã–ª—å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ DNS –Ω–∞ –≤–∏–Ω–¥–µ. –ù–∞ –í–ò–ù–î–ï, –ö–∞—Ä–ª!!! –ù–µ —É–≤–µ—Ä–µ–Ω, —á—Ç–æ –∫—Ç–æ-—Ç–æ –∑–∞—Ö–æ—á–µ—Ç –ø–æ–π—Ç–∏ —Ç–∞–∫–∏–º –ø—É—Ç–µ–º, –∞ –µ—Å–ª–∏ –∏ –∑–∞—Ö–æ—á–µ—Ç, —Ç–æ –≤—ã–ª–æ–∂—É –∫–∞–∫ –±—É–¥–µ—Ç –≤—Ä–µ–º—è –≤–æ 2 —á–∞—Å—Ç–∏ —Å—Ç–∞—Ç—å–∏.

<br/>

## –ù–∞—á–∏–Ω–∞–µ–º –ø–∏—Å–∞—Ç—å playbook ######

–ö–∞–∫ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ansible —è –ø–∏—Å–∞—Ç—å –Ω–µ –±—É–¥—É, —è –¥—É–º–∞—é —ç—Ç–æ –∏ –±–µ–∑ –º–æ–∏—Ö –Ω–∞—Å—Ç–∞–≤–ª–µ–Ω–∏–π –∫–∞–∂–¥—ã–π —Å–¥–µ–ª–∞–µ—Ç.
–ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –æ—Å—Ç–∞–≤–ª—é —Å—Å—ã–ª—å –Ω–∞ –æ—Ñ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é [–¥–æ–∫—É](http://docs.ansible.com/ansible/intro_installation.html).

–ò—Ç–∞–∫, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–æ—á–∫—É playbooks –∏ —Å–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É —Å –Ω–∞—à–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –¥–ª—è —Ä–∞—Å–∫–∞—Ç–∫–∏ Zabbix.  
`mkdir playbooks/zabbix_agent`

–î–∞–ª–µ–µ —Å–æ–∑–¥–∞–µ–º yaml —Ñ–∞–π–ª, –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ–º –æ–ø–∏—Å—ã–≤–∞—Ç—å —Ç–∞—Å–∫–∏ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:  
`touch zabbix.yml`

```yaml
- hosts: target
  vars:
      zabbix_server: zabbix.lc
      zabbix_server_port: 10051
      zabbix_agent_port: 10050
      zabbix_login: login
      zabbix_pass: pass
      zabbix_url: https://zabbix.ru
```

–Ø –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ –∫–∞–∂–µ—Ç—Å—è –∫—Ä–∏–≤–æ, —É–∫–∞–∑–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä—è–º–æ –≤ –ø–ª—ç–π–±—É–∫–µ, –¥–∞ –∏ –ø–æ—á–µ–º—É –≤–æ–æ–±—â–µ —ç—Ç–æ –Ω–µ —Ä–æ–ª—å!? –¢–∞–∫–æ–π –≤–∏–¥ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏, –∞ –Ω–µ –¥–ª—è –ª–æ–∫–∞–Ω–∏—á–Ω–æ—Å—Ç–∏.
–ö—Å—Ç–∞—Ç–∏ –∑–¥–µ—Å—å —É–∫–∞–∑–∞–Ω–∞ –≥—Ä—É–ø–ø–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ `target`, —Ç–µ —Å–µ—Ä–≤–µ—Ä–∞, –Ω–∞–¥ –∫–æ—Ç–æ—Ä—ã–º–∏ –±—É–¥—É—Ç —Å–æ–≤–µ—Ä—à–µ–Ω—ã –¥–µ–π—Å—Ç–≤–∏—è –∏–∑ –∏–Ω–≤–µ–Ω—Ç–æ—Ä–∏ —Ñ–∞–π–ª–∞ hosts.

–î–∞–ª—å—à–µ –Ω–∞—á–Ω–µ–º —Å 1 —Ç–∞—Å–∫–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ —Ö–æ—Å—Ç zabbix –∞–≥–µ–Ω—Ç–∞.  

```yaml
  - name: install zabbix repo
    yum:
        name: https://repo.zabbix.com/zabbix/3.2/rhel/7/x86_64/zabbix-release-3.2-1.el7.noarch.rpm
        state: installed
```
–ó–¥–µ—Å—å –º—ã –≥–æ–≤–æ—Ä–∏–º, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ —Ö–æ—Å—Ç rpm –ø–∞–∫–µ—Ç zabbix —á–µ—Ä–µ–∑ –ø–∞–∫–µ—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä yum.  

–î–∞–ª–µ–µ —É—Å—Ç–∞–Ω–æ–≤–∏–º —Å–∞–º Zabbix Agent:  

```yaml
  - name: install zabbix agent
    yum:
        name: zabbix-agent
        state: installed
```
–í –ø—Ä–∏–Ω—Ü–∏–ø–µ –ø—Ä–∏–º–µ—Ä, –∞–Ω–∞–ª–æ–≥–∏—á–µ–Ω –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω–æ–º—É –≤—ã—à–µ.  

–ó–∞—Ç–µ–º, –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–≥–µ–Ω—Ç–∞, –Ω—É–∂–Ω–æ —Å–∫–æ—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ, –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∑–∞–¥–∞—Ç—å –∏–º—è. –¢—É—Ç –Ω–∞–ø–æ–º–æ—â—å –ø—Ä–∏—Ö–æ–¥–∏—Ç –º–æ–¥—É–ª—å –∞–Ω—Å–∏–±–ª–∞ [template](http://docs.ansible.com/ansible/template_module.html). 

```yaml
  - name: make zabbix config
    template:
        src: zabbix_agentd.conf.j2
        dest: /etc/zabbix/zabbix_agentd.conf
        owner: zabbix
        group: zabbix
        mode: 0644
    notify:
        - restart zabbix-agent
```
–ß—Ç–æ —Ç—É—Ç –¥–µ–ª–∞–µ—Ç—Å—è, –±–µ—Ä–µ—Ç—Å—è –∑–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω jinja2, –≤ –∫–æ—Ç–æ—Ä–æ–º –æ—Ç–º–µ—á–∞—é—Ç—Å—è –º–µ—Å—Ç–∞ –∫—É–¥–∞ –Ω—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ. –û–Ω–∏ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –∏ –∫–æ–Ω—Ñ–∏–≥ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Ö–æ—Å—Ç, –Ω–∞–∑–Ω–∞—á–∞—é—Ç—Å—è –ø—Ä–∞–≤–∞ 644, –∞ —Ç–∞–∫–∂–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –≤–ª–∞–¥–µ–ª–µ—Ü –∏ –≥—Ä—É–ø–ø–∞ `zabbix:zabbix`. –¢–∞–∫ –∂–µ –∑–¥–µ—Å—å –ø–∞—Ä–∞–º–µ—Ç—Ä notify –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç handler `restart zabbix-agent` –≤ –∫–æ–Ω—Ü–µ –ø–ª—ç–π–±—É–∫–∞.  
–¢–∞–∫ –ø—Ä–æ–ø–∏—Å—ã–≤–∞–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ –≤ —à–∞–±–ª–æ–Ω–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –Ω—É–∂–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö:  
```
{% raw %}
Server={{ zabbix_server }}
ListenPort={{ zabbix_agent_port }}
Hostname={{ inventory_hostname }}
{% endraw %}
```

–Ø –Ω–∞–≤–µ—Ä–Ω—è–∫–∞ —É–≤–µ—Ä–µ–Ω, —á—Ç–æ —É –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–∏—Ç —Ñ–∞–µ—Ä–≤–æ–ª –∏ –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫ –Ω–∞—á–∞—Ç—å –ª–æ–º–∏—Ç—å—Å—è –≤ –ø–æ—Ä—Ç –∞–≥–µ–Ω—Ç–∞ –Ω–µ –ø–æ–ª—É—á–∏—Ç—å—Å—è. –í –º–æ–µ–º —Å–ª—É—á–∞–µ —ç—Ç–æ iptables, –ø–æ—ç—Ç–æ–º—É —Å–ª–µ–¥—É—é—â–∏–π —Ç–∞—Å–∫:  

```yaml
  - name: allow port {{ zabbix_agent_port }} in iptables
    iptables: chain=INPUT action=insert ctstate=NEW protocol=tcp match=tcp destination_port={{ zabbix_agent_port }} jump=ACCEPT

```
–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ iptables:  

```yaml
  - name: iptables save
    command: service iptables save
```

–ò—Ç–∞–∫ –∞–≥–µ–Ω—Ç–∞ –º—ã –ø–æ—Å—Ç–∞–≤–∏–ª–∏, —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏–ª–∏. –ù—É–∂–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –≥—Ä—É–ø–ø—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Zabbix –¥–ª—è –Ω–æ–≤–æ–∏—Å–ø–µ—á–µ–Ω–Ω—ã—Ö —Ö–æ—Å—Ç–æ–≤. –ß—Ç–æ–±—ã –≤—ã –ø—Ä–æ—Å—Ç–æ –ø–æ–Ω–∏–º–∞–ª–∏, –¥–Ω—Å –∑–∞–ø–∏—Å–∏ —Ö–æ—Å—Ç–æ–≤ —É –Ω–∞—Å –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫: `app1.prod.portal`, –≥–¥–µ

* app1 - —ç—Ç–æ —á—Ç–æ –∑–∞ —Å–µ—Ä–≤–∏—Å —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞ —Ö–æ—Å—Ç–µ, 

* prod - —Å—Ä–µ–¥–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è, 

* portal - –ø—Ä–æ–µ–∫—Ç. 

–ü–æ—ç—Ç–æ–º—É –∏–∑ –≥—Ä—É–ø–ø –º–Ω–µ –≤–ø–æ–ª–Ω–µ –±—É–¥–µ—Ç —Ö–≤–∞—Ç–∞—Ç—å –≥—Ä—É–ø–ø—ã —Å—Ä–µ–¥—ã –∏ –≥—Ä—É–ø–ø—ã –ø—Ä–æ–µ–∫—Ç–∞.
–° —ç—Ç–∏–º –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏—Å—å, –Ω–æ –∫–∞–∫ —ç—Ç–∏ –≥—Ä—É–ø–ø—ã –∞–≤—Ç–æ–º–∞—Ç–æ–º? –ù–∞ –ø–æ–º–æ—â—å –Ω–∞–º –ø—Ä–∏—Ö–æ–¥–∏—Ç Zabbix Api, –∞ —Å –Ω–∏–º –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ pyzabbix –Ω–∞ –ø–∏—Ç–æ–Ω–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞–ø–∏.  
–°—Ç–∞–≤–∏—Ç—Å—è –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ:  
`pip install pyzabbix` 

–ù—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—ã –±—Ä–∞–ª –æ—Ç –¥–Ω—Å —Ö–æ—Å—Ç–∞ —Å—Ä–µ–¥—É –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –∏, –∏—Å–ø–æ–ª—å–∑—É—è –∞–ø–∏, —Å–æ–∑–¥–∞–≤–∞–ª –±—ã –≥—Ä—É–ø–ø—ã: 

```yaml
{% raw %}
  - name: Add first group to zabbix web
    local_action: command python -c 'from pyzabbix import ZabbixAPI; zapi = ZabbixAPI("{{ zabbix_url }}"); zapi.login("{{ zabbix_login }}", "{{ zabbix_pass }}"); group1 = zapi.hostgroup.create(name="{{ inventory_hostname.split('.')[1] }}")'
    ignore_errors: yes

  - name: Add second group to zabbix web
    local_action: command python -c 'from pyzabbix import ZabbixAPI; zapi = ZabbixAPI("{{ zabbix_url }}"); zapi.login("{{ zabbix_login }}", "{{ zabbix_pass }}"); group2 = zapi.hostgroup.create(name="{{ inventory_hostname.split('.')[2] }}")'
    ignore_errors: yes
{% endraw %}
```

–î–µ–ª–∞–µ–º —Ñ–∏–Ω—Ç —É—à–∞–º–∏ –∏ –¥–æ—Å—Ç–∞–µ–º –≥—Ä—É–ø–ø—ã, —Ä–∞–∑–±–∏–≤–∞—è —Å—Ç—Ä–æ–∫—É –ø–æ —Ç–æ—á–∫–µ. –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥—É–ª—å local_action —á—Ç–æ–±—ã –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç —Å —Ö–æ—Å—Ç–∞ ansible, –≤ –∫–æ–Ω—Ü–µ –≥–æ–≤–æ—Ä–∏–º –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å, –µ—Å–ª–∏ —Ç–∞–∫–∞—è –≥—Ä—É–ø–ø–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ú–æ–∂–Ω–æ –±—ã–ª–æ –Ω–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–∫–æ–π –≥—Ä—É–ø–ø—ã –∏ –µ—Å–ª–∏ —Ç–∞–∫–æ–π –Ω–µ—Ç –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å, –Ω–æ –º–Ω–µ –ª–µ–Ω—å üòä

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø —Ö–æ—Å—Ç–æ–≤, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –Ω–∏—Ö –≥—Ä—É–ø–ø–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ü–æ –±–û–ª—å—à–µ —Å—Ç–µ–ø–µ–Ω–∏ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –∞–ª–µ—Ä—Ç–∏—Ç –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö. –ï–º—É –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –Ω–∞ —á—Ç–µ–Ω–∏–µ –≤–æ –≤—Å–µ —Ö–æ—Å—Ç—ã. –ò—Ç–∞–∫, –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥ [usergroup.update](https://www.zabbix.com/documentation/3.0/manual/api/reference/usergroup/update), –∞ –¥–ª—è —ç—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å id –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ id –≥—Ä—É–ø–ø —Ö–æ—Å—Ç–æ–≤, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–¥–∞—Ç—å –ø—Ä–∞–≤–∞. –° –ø–æ–º–æ—â—å—é –º–µ—Ç–æ–¥–∞ [usergroup.get](https://www.zabbix.com/documentation/3.0/ru/manual/api/reference/usergroup/get) –Ω–∞—Ö–æ–¥–∏–º id –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ —Å–ª–µ–¥—É—é—â–∏–π —Å–∫—Ä–∏–ø—Ç:  
```python
from pyzabbix import ZabbixAPI

zapi = ZabbixAPI("https://zabbix.ru/")
zapi.login("login", "pass")

ids = [group['groupid'] for group in zapi.hostgroup.get()] # –ë–µ—Ä–µ–º –≤—Å–µ id –≥—Ä—É–ø–ø —Ö–æ—Å—Ç–æ–≤

rights = [{'permission': 2, 'id': i} for i in ids] # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –∏–∑ –ø—Ä–∞–≤ –∏ –≥—Ä—É–ø–ø —Ö–æ—Å—Ç–æ–≤, 'permission': 2 - –¥–∞–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ
zapi.usergroup.update(			 # –ê–ø–¥–µ–π—Ç–∏–º –≥—Ä—É–ø–ø—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    usrgrpid=13,			     # ID –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –≤–∑—è—Ç—ã–π –∏–∑ –º–µ—Ç–æ–¥–∞ usergroup.get
    rights=rights
)
```

–î–µ–ª–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–∞—Å–∫ –≤ –ø–ª—ç–π–±—É–∫–µ:  
```yaml
  - name: Add grants on groups
    local_action: command python /Users/ossidorenkov/ansible/playbooks/zabbix_agent/add_grants.py
```

–ù–∞ –≤—ã—Ö–æ–¥–µ –ø–æ–ª—É—á–∞–µ–º –Ω–µ—á—Ç–æ –ø–æ–¥–æ–±–Ω–æ–µ:

<img src="{{ site.img_path }}/automate_zabbix/zab1.png" width="70%">

<br/>

–î–∞–ª–µ–µ —Å–æ–∑–¥–∞–¥–∏–º —Å–∞–º —Ö–æ—Å—Ç –≤ –∞–¥–º–∏–Ω–∫–µ Zabbix –∏ –ø–æ–º–µ—Å—Ç–∏–º –µ–≥–æ –≤ —Ç–µ –≥—Ä—É–ø–ø—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–∑–¥–∞–ª–∏. –ó–¥–µ—Å—å —É–∂–µ –≥–æ–≤–æ—Ä–æ–¥–∏—Ç—å —Å–∞–º–æ–ø–∏—Å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –Ω–µ –ø—Ä–∏–¥–µ—Ç—Å—è, –∑–∞ –≤–∞—Å —ç—Ç–æ —Å–¥–µ–ª–∞–µ—Ç ansible module - [zabbix-host](http://docs.ansible.com/ansible/zabbix_host_module.html). –ö–∞–∫ –≤–∏–¥–Ω–æ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è –º–æ–¥—É–ª—è, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Ö–æ—Å—Ç –∞–Ω—Å–∏–±–ª–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫—É zabbix-api: 
`pip install zabbix-api`

–î–∞–ª–µ–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ —Å–∞–º —Ç–∞—Å–∫:  

```yaml
{% raw %}
- name: Create a new host or update an existing host's info
    local_action:
      module: zabbix_host
      server_url: "{{ zabbix_url }}"
      login_user: "{{ zabbix_login }}"
      login_password: "{{ zabbix_pass }}"
      host_name: "{{ inventory_hostname }}"
      host_groups:
        - "{{ inventory_hostname.split('.')[1] }}"
        - "{{ inventory_hostname.split('.')[2] }}"
      link_templates:
        - Template OS Linux
      status: enabled
      state: present
      inventory_mode: automatic
      interfaces:
        - type: 1
          main: 1
          useip: 0
          ip: ""
          dns: "{{ inventory_hostname }}"
          port: "{{ zabbix_agent_port }}"
{% endraw %}
```
–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º –∫–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ—Å—Ç—É–ø–Ω—ã —É –¥–∞–Ω–Ω–æ–≥–æ –º–æ–¥—É–ª—è —á–∏—Ç–∞–π—Ç–µ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏–∑ —Å—Å—ã–ª–∫–∏ –≤—ã—à–µ.
<br/>

–ù—É –∏ –≤ –∫–æ–Ω—Ü–µ –ø–ª—ç–π–±—É–∫–∞ –ø–∏—à–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —Ä–µ—Å—Ç–∞—Ä—Ç –∞–≥–µ–Ω—Ç–∞ –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ –≤ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É: 

```yaml
  handlers:
      - name: restart zabbix-agent
        service:
            name: zabbix-agent
            state: restarted
            enabled: yes
```

–ò—Ç–∞–∫, –ø—Ä–∏–º–µ—Ä –ø–æ—à–∞–≥–æ–≤–æ:

–£ –≤–∞—Å –∑–∞–ø–æ–ª–Ω–µ–Ω –∏–Ω–≤–µ–Ω—Ç–æ—Ä–∏ —Ñ–∞–π–ª hosts:
```
[target]
pgsql3.prod.sgr.sber ansible_user=deployment ansible_ssh_private_key_file=/Users/ossidorenkov/ansible/deployment_id_rsa
```

–ó–∞–ø—É—Å–∫–∞–µ–º playbook:  
`ansiblansible-playbook -i my_inventories/hosts -b playbooks/zabbix_agent/zabbix.yml`

–ñ–¥—ë–º—Å...

```
PLAY RECAP *********************************************************************
pgsql3.prod.sgr.sber       : ok=12   changed=11   unreachable=0    failed=0
```

–ò–¥–µ–º –ø—Ä–æ–≤–µ—Ä—è—å —Ö–æ—Å—Ç –≤ –∞–¥–º–∏–Ω–∫—É: 

<img src="{{ site.img_path }}/automate_zabbix/zab3.png" width="70%">

–í—É–∞–ª—è, —Ö–æ—Å—Ç –ø–æ—è–≤–∏–ª—Å—è, –¥–æ—Å—Ç—É–ø–µ–Ω, –≤ –Ω—É–∂–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö –∏ –ø—Ä–∏—Ü–µ–ø–ª–µ–Ω –∫ —à–∞–±–ª–æ–Ω—É. –ö—Ä–∞—Å–æ—Ç–∞!

<br/>

–ü–æ–ª–Ω—ã–π playbook, –∞ —Ç–∞–∫–∂–µ —Å–∫—Ä–∏–ø—Ç—ã –∏ —à–∞–±–ª–æ–Ω—ã, –≤—ã –º–æ–∂–µ—Ç–µ —Å–∫–∞—á–∞—Ç—å —Å –º–æ–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–∞ [GitHub](https://github.com/OSidorenkov/ansible-playbook).
