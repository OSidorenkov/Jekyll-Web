---
layout: post
title:  "Zabbix in Telegram"
date:   2017-02-13
desc: "–ö–∞–∫ –ø—Ä–∏–∫—É—Ä–∏—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏—è Zabbix –∫ telegram"
keywords: "Telegram,Zabbix,–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥,–æ–ø–æ–≤–µ—â–µ–Ω–∏—è, Hyper-V"
categories: [Zabbix]
tags: [Zabbix,Telegram,–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥]
icon: fa fa-television
---

–í –¥–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç—å–µ –±—É–¥–µ—Ç –æ–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Zabbix –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –≤ –∫–∞–Ω–∞–ª –¢–µ–ª–µ–≥—Ä–∞–º. –û —Ç–æ–º, –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª –≤ –¢–µ–ª–µ–≥—Ä–∞–º, –∞ –∑–∞—Ç–µ–º –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –µ–≥–æ –∏–∑ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –≤ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∏—Ç–∞–π—Ç–µ –Ω–∏–∂–µ:  

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è / –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ######

–¢–∞–∫ –∫–∞–∫ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–ø–æ–≤–µ—â–µ–Ω–∏–π –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ python, –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –Ω–∞ —Å–µ—Ä–≤–µ—Ä:  
`yum install python`

–¢–∞–∫–∂–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã  –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å:  
`pip install requests`

–°–∫–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Å–µ–±–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å —Å–∫—Ä–∏–ø—Ç–∞–º–∏:  
`git clone https://github.com/ableev/Zabbix-in-Telegram.git`

* –ö–æ–ø–∏—Ä—É–µ–º `zbxtg.py` –∏ `zbxtg_group.py` –≤ _AlertScriptsPath_ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é Zabbix, –ø—É—Ç—å —É–∫–∞–∑–∞–Ω –≤ zabbix_server.conf
* –°–æ–∑–¥–∞–µ–º `zbxtg_settings.py` –≤ –∫–æ—Ç–æ—Ä–æ–º –ø—Ä–æ–ø–∏—Å—ã–≤–∞–µ—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ:

```python
# -*- coding: utf-8 -*-

tg_key = "XYZ"  # telegram bot api key

zbx_tg_prefix = "zbxtg"  # variable for separating text from script info
zbx_tg_tmp_dir = "/tmp/" + zbx_tg_prefix  # directory for saving caches, uids, cookies, etc.
zbx_tg_signature = False

zbx_server = "http://localhost"  # zabbix server full url
zbx_api_user = "api"
zbx_api_pass = "api"
zbx_api_verify = True  # True - do not ignore self signed certificates, False - ignore

proxy_to_zbx = None
proxy_to_tg = None

#proxy_to_zbx = "proxy.local:3128"
#proxy_to_tg = "proxy.local:3128"

emoji_map = {
    "ok": "‚úÖ",
    "problem": "‚ùó",
    "info": "‚ÑπÔ∏è",
    "warning": "‚ö†Ô∏è",
    "disaster": "‚ùå",
    "bomb": "üí£",
    "fire": "üî•",
    "hankey": "üí©",
}
```

* –°–æ–∑–¥–∞–µ–º –±–æ—Ç–∞ Telegram, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω, –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º "API key"

* –°–æ–∑–¥–∞–µ–º —é–∑–µ—Ä–∞ –≤ Zabbix –∏ –¥–∞–µ–º –µ–º—É –ø—Ä–∞–≤–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ (–¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤)

* –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π "–°–ø–æ—Å–æ–± –æ–ø–æ–≤–µ—â–µ–Ω–∏—è" –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Zabbix c –ø–æ–¥–æ–±–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:  

	<img src="{{ site.img_path }}/telegram_zabbix/image1.png">

* –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ "–î–µ–π—Å—Ç–≤–∏–µ", –Ω–∞–ø—Ä–º–µ—Ä:  

	<img src="{{ site.img_path }}/telegram_zabbix/image2.png">

	* –¢–µ–∫—Å—Ç –æ –ø—Ä–æ–±–ª–µ–º–µ:
```
Last value:{ITEM.VALUE1} ({TIME})
zbxtg;graphs
zbxtg;graphs_period=1800
zbxtg;itemid:{ITEM.ID1}
zbxtg;title:{HOST.HOST} - {TRIGGER.NAME}
–í–∞–∂–Ω–æ—Å—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä–∞: {TRIGGER.SEVERITY}
Server: {HOSTNAME} ({HOST.IP})
–û–ø–∏—Å–∞–Ω–∏–µ:
{TRIGGER.DESCRIPTION}
```

	* –°–æ–æ–±—â–µ–Ω–∏–µ –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏:
```
Server: {HOSTNAME} ({HOST.IP})
–û–ø–∏—Å–∞–Ω–∏–µ:
–ü—Ä–æ–±–ª–µ–º–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞!
–í—Ä–µ–º—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã: {DATE} {TIME}
```

* –î–æ–±–∞–≤–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–Ω—ã–π —Ç–∏–ø –æ–ø–æ–≤–µ—â–µ–Ω–∏—è(–≤ –≥—Ä–∞—Ñ–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º chat_id –∫–∞–Ω–∞–ª–∞, –∫–∞–∫ –µ–≥–æ –ø–æ–ª—É—á–∏—Ç—å, —á–∏—Ç–∞—Ç—å –Ω–∏–∂–µ):  

<img src="{{ site.img_path }}/telegram_zabbix/image3.png">

<br>

## –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ ######

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|---|---|
| zbxtg;channel  | –í–∫–ª—é—á–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π –≤ –∫–∞–Ω–∞–ª  |
| zbxtg;graphs  | –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏  |
| zbxtg;graphs_period  | –ó–∞–¥–∞–µ—Ç –ø–µ—Ä–∏–æ–¥ –≥—Ä–∞—Ñ–∏–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3600 —Å–µ–∫—É–Ω–¥)  |
| zbxtg;graphs_width  | –ó–∞–¥–∞–µ—Ç –≥—Ä–∞—Ñ–∏–∫—É —à–∏—Ä–∏–Ω—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 900px)  |
| zbxtg;graphs_height  | –ó–∞–¥–∞–µ—Ç –≥—Ä–∞—Ñ–∏–∫—É –≤—ã—Å–æ—Ç—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 300px)  |
| zbxtg;itemid:{ITEM.ID1}  | –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç itemid (–æ—Ç —Ç—Ä–∏–≥–≥–µ—Ä–∞) –¥–ª—è –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞  |
| zbxtg;title:{HOST.HOST} - {TRIGGER.NAME}  | –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä–∞—Ñ–∏–∫–∞  |
| zbxtg;debug  | –í–∫–ª—é—á–∞–µ—Ç debug mode, –ª–æ–≥–∏ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ tmp –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏  |	

<br>

–¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∏–ª–∏—Å—Ç–∏–∫—É –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –¥–µ–π—Å—Ç–≤–∏—è:  [markdown-style](https://core.telegram.org/bots/api#markdown-style) + [html-style](https://core.telegram.org/bots/api#html-style).

<br>

## –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ ######

–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –∫–∞–Ω–∞–ª –≤ –∫–ª–∏–µ–Ω—Ç–µ –¢–µ–ª–µ–≥—Ä–∞–º, –∑–∞—Ç–µ–º —É –≤–∞—Å —Å–ø—Ä–æ—Å—è—Ç –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø(–ü—É–±–ª–∏—á–Ω—ã–π –∏–ª–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π), –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π, —Ç–∞–∫ –∫–∞–∫ –±–µ–∑ —ç—Ç–æ–≥–æ –º—ã –Ω–µ —É–∑–Ω–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π chatid, –±–µ–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –±—É–¥–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–Ω—è—Ç—å –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –±–æ—Ç—É.  

<img src="{{ site.img_path }}/telegram_zabbix/image4.png">  

–í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ UserName –∫–∞–Ω–∞–ª–∞ —è–≤–ª—è–µ—Ç—Å—è @–¢estZabbix, –¥–æ–±–∞–≤–ª—è–µ–º —Ç—É–¥–∞ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞ –∏ –¥–µ–ª–∞–µ–º –µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º(–¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π). –ó–∞—Ç–µ–º —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å chat_id –æ—Ç–∫—Ä—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä –∏ –ø–æ—Å—ã–ª–∞–µ–º —Å–µ–±–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª –æ—Ç –±–æ—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É—è API Telegram:  

`https://api.telegram.org/botXxX:XXXXxxxxxxxXXXXxXxXXxxx/sendMessage?chat_id=@TestZabbix&text=HelloWorld!`

–í –æ—Ç–≤–µ—Ç –º—ã –ø–æ–ª—É—á–∏–º –Ω—É–∂–Ω—ã–π –Ω–∞–º chat_id –∏ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–µ–ª—ã–≤–∞—Ç—å –∫–∞–Ω–∞–ª –∏–∑ Public –≤ Private, –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π –≤ –Ω–µ–º. –ï–≥–æ –∏ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–∏—Ç—å –≤ –≥—Ä–∞—Ñ—É "–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞" –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Zabbix.

<br>

## Debug ######

–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: Zabbix –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç —Å —Ç—Ä–µ–º—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, —Ç–∞–∫ —á—Ç–æ –µ—Å–ª–∏ –≤—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –µ–≥–æ –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ, —Å –æ–¥–Ω–∏–º –∏–ª–∏ —Å –¥–≤—É–º—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –Ω–∞–¥–æ. –í —Å–ª—É—á–∞–µ —É—Å–ø–µ—Ö–∞ –≤—ã –Ω–µ —É–≤–∏–¥–∏—Ç–µ –Ω–∏–∫–∞–∫–∏—Ö –æ—à–∏–±–æ–∫, –∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.

<br>

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç–∞

`$ ./zbxtg.py "@OSSidorenkov" "test" "test"`

<br>

### –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ

* username —Ä–µ–≥–∏—Å—Ç—Ä–æ–∑–∞–≤–∏—Å–∏–º—ã–π

* –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ—Å–ª–∞–ª–∏ –±–æ—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–µ (one-to-one message)

* –µ—Å–ª–∏ –≤–∏–¥–∏—Ç–µ "User 'username' needs to send some text bot in private" , —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –≤—ã –Ω–µ –ø–æ—Å–ª–∞–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É

<br>

### –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –≤ –∫–∞–Ω–∞–ª

```sudo -u zabbix /var/lib/zabbixsrv/alertscripts/zbxtg_channel.py "@TestZabbix" "Test" "$(echo -e 'zbxtg;graphs\nzbxtg;itemid:28458\nzbxtg;debug\nzbxtg;title:test')" --channel```		


–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–µ—Ä–≤–æ–∏—Å—Ç–æ—á–Ω–∏–∫:	
[https://github.com/ableev/Zabbix-in-Telegram](https://github.com/ableev/Zabbix-in-Telegram)  
–ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∏ –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –æ—Ü–µ–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∑–≤–µ–∑–¥–æ—á–∫–æ–π –Ω–∞ GitHub.  
–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:  

* –°–æ–æ–±—â–µ—Å—Ç–≤–æ –ø–æ —ç—Ç–æ–º—É –ø—Ä–æ–µ–∫—Ç—É –≤ —Ç–µ–ª–µ–≥—Ä–∞–º: [https://telegram.me/ZbxTg](https://telegram.me/ZbxTg)

* –ù–æ–≤–æ—Å—Ç–∏ –ø–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é –ø—Ä–æ–µ–∫—Ç–∞: [https://telegram.me/Zabbix_in_Telegram](https://telegram.me/Zabbix_in_Telegram)	
```sudo -u zabbix /var/lib/zabbixsrv/alertscripts/zbxtg_channel.py "@TestZabbix" "Test" "$(echo -e 'zbxtg;graphs\nzbxtg;itemid:28458\nzbxtg;debug\nzbxtg;title:test')" --channel```
